<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="keywords" content="CI/CD Jenkins Pipelines NodeJs Docker KeystoneJs">
<title>Despliegue continuo y entrega continua</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Despliegue continuo y entrega continua</h1>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#_prerrequisitos">1. Prerrequisitos</a>
<ul class="sectlevel2">
<li><a href="#_cupones_educativos_google_cloud">1.1. Cupones educativos Google Cloud</a></li>
<li><a href="#_terraform">1.2. Terraform</a></li>
<li><a href="#_gcloud_cli_para_gcp">1.3. GCloud CLI para  GCP</a></li>
<li><a href="#_github_student_education_pack">1.4. Github Student Education Pack</a></li>
</ul>
</li>
<li><a href="#_creación_de_la_infraestructura_en_google_cloud">2. Creación de la infraestructura en Google Cloud</a>
<ul class="sectlevel2">
<li><a href="#_estructura_del_proyecto_terraform">2.1. Estructura del proyecto terraform</a></li>
<li><a href="#_ejecución_de_terraform">2.2. Ejecución de terraform</a></li>
</ul>
</li>
<li><a href="#_cloud_dns">3. Cloud DNS</a>
<ul class="sectlevel2">
<li><a href="#_alta_de_nombre_de_dominio">3.1. Alta de nombre de dominio</a></li>
<li><a href="#_configuración_de_nombres_de_dominio">3.2. Configuración de nombres de dominio</a></li>
</ul>
</li>
<li><a href="#_instalación_de_jenkins">4. Instalación de Jenkins</a>
<ul class="sectlevel2">
<li><a href="#_construcción_de_la_imagen_del_contenedor_jenkins">4.1. Construcción de la imagen del contenedor Jenkins</a></li>
<li><a href="#_publicación_en_google_container_registry">4.2. Publicación en Google Container Registry</a></li>
<li><a href="#_ejecución_del_contenedor_de_jenkins">4.3. Ejecución del contenedor de Jenkins</a></li>
<li><a href="#_configuración_básica_de_jenkins">4.4. Configuración básica de Jenkins</a></li>
<li><a href="#_creación_del_primer_proyecto_jenkins">4.5. Creación del primer proyecto Jenkins</a></li>
<li><a href="#_instalación_de_plugins_adicionales">4.6. Instalación de plugins adicionales</a></li>
<li><a href="#_configuración_las_tools_en_jenkins">4.7. Configuración las tools en Jenkins</a></li>
<li><a href="#_conexión_con_la_máquina_de_despliegue">4.8. Conexión con la máquina de despliegue</a></li>
</ul>
</li>
<li><a href="#_ejemplo_1_aplicación_web_java">5. Ejemplo 1: Aplicación web Java.</a>
<ul class="sectlevel2">
<li><a href="#_creación_de_proyecto_jenkins_con_pipelines">5.1. Creación de proyecto Jenkins con pipelines</a></li>
<li><a href="#_informe_de_cobertura_de_código">5.2. Informe de Cobertura de código</a></li>
<li><a href="#_análisis_estático_de_código_checkstyle">5.3. Análisis estático de código: <em>Checkstyle</em></a></li>
<li><a href="#_despliegue_en_la_vm">5.4. Despliegue en la VM</a></li>
<li><a href="#_despliegue_en_un_contenedor_docker">5.5. Despliegue en un contenedor Docker</a></li>
</ul>
</li>
<li><a href="#_ejemplo_2_hola_mundo_en_nodejs">6. Ejemplo 2. Hola mundo en NodeJs</a>
<ul class="sectlevel2">
<li><a href="#_creación_de_proyecto_jenkins_con_pipelines_2">6.1. Creación de proyecto Jenkins con pipelines</a></li>
<li><a href="#_despliegue_en_la_vm_2">6.2. Despliegue en la VM</a></li>
<li><a href="#_deploy_en_un_docker_container">6.3. Deploy en un Docker container</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Computación en la nube servicios y aplicaciones.
Version 1.0, Marzo-2020.
Joaquín Cañadas &lt;<a href="mailto:jjcanada@ual.es">jjcanada@ual.es</a>&gt;</p>
</div>
<div class="quoteblock abstract">
<blockquote>
Tema 3. Despliegue Continuo
</blockquote>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Crear una infraestructura de CI/CD en GCP</p>
</li>
<li>
<p>Diseñar proyectos Jenkins para la construcción y despliegue automatizado de aplicaciones en Java y NodeJs</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Realización y entrega</div>
<div class="paragraph">
<p>La realización de estas actividades se realizará de forma individual. Serán la base para actividades posteriores que ser harán en equipo.
La entrega será mediante el envío de un informe y el acceso al profesor a los servicios configurados, para la revisión y evaluación de los mismos.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerrequisitos">1. Prerrequisitos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para comenzar a trabajar, será necesario tener instalados en la máquina local las siguientes herramientas: Terraform, Google Cloud CLI. Se presupone que ya se tiene instalado un entorno de desarrollo como Visual Studio Code, y una pareja de claves SSH personal en la carpeta <code>HOME</code> del usuario (<code>~</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>~/.ssh/
├── id_rsa <i class="conum" data-value="1"></i><b>(1)</b>
└── id_rsa.pub <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>clave privada</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>clave pública</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además, se debe disponer de crédito en GCP, proporcionado por el profesor, y darse de alta en Github Student Education Pack. A continuación se describen en detalle estos requisitos previos.</p>
</div>
<div class="sect2">
<h3 id="_cupones_educativos_google_cloud">1.1. Cupones educativos Google Cloud</h3>
<div class="paragraph">
<p>Si ya dispones de crédito en GCP, podrás usarlo ahora. En cualquier caso, para esta asignatura disponemos de un nuevo cupón educativo de 50$ por estudiante, que no necesita tarjeta de crédito para su activación. Actívalo en la dirección que habrá recibido en tu email, usando tu email <em>@inlumine.ual.es</em>.</p>
</div>
<div class="paragraph">
<p><strong>Crea un nuevo proyecto</strong> GCP con el nombre <strong>cnsa2020-<em>abc123</em></strong> (sustituyendo <em>abc123</em> por tu nombre de usuario), y dale permisos al profesor. Para ello, revisa las instrucciones que vimos en la asignatura del primer cuatrimestre. El crédito del cada cupón dura 12 meses, así que este nuevo proyecto asígnalo a la cuenta de facturación de la asignatura del primer cuatrimestre, ya que es mejor consumir ese crédito porque caduca antes. Si se consume el crédito del primer cupón, simplemente tendrás que cambiar tu proyecto <strong>cnsa2020-<em>abc123</em></strong> a la nueva cuenta de facturación del nuevo cupón.</p>
</div>
</div>
<div class="sect2">
<h3 id="_terraform">1.2. Terraform</h3>
<div class="paragraph">
<p>Terraform es una aplicación que se distribuye en un único archivo ejecutable. Las instrucciones de instalación de Terraform está disponibles <a href="https://learn.hashicorp.com/terraform/getting-started/install.html">aquí</a>.</p>
</div>
<div class="paragraph">
<p>En Windows se recomienda instalarlo con <a href="https://chocolatey.org/docs/installation">Chocolatey</a>. Así que si previamente has instalado Chocolatey, simplemente abre una ventana de comandos (cmd) con <strong>permiso de administrador</strong> y ejecuta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">choco <span class="nb">install </span>terraform <span class="nt">-y</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gcloud_cli_para_gcp">1.3. GCloud CLI para  GCP</h3>
<div class="paragraph">
<p>Google Cloud Command Line Interface está disponible para su instalación <a href="https://cloud.google.com/sdk/install">aquí</a>.</p>
</div>
<div class="paragraph">
<p>En Windows se recomienda instalarlo con Chocolatey: abre una ventana de comandos (cmd) con <strong>permiso de administrador</strong> y ejecuta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">choco <span class="nb">install </span>gcloudsdk <span class="nt">-y</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_github_student_education_pack">1.4. Github Student Education Pack</h3>
<div class="paragraph">
<p>Para poder usar servicios adicionales, como DNS gratuito, debes darte de alta en <a href="https://education.github.com/pack">Github Student Education Pack</a>.</p>
</div>
<div class="paragraph">
<p>Si ya dispones de una cuenta de GitHub, y no quieres crear una cuenta nueva, simplemente debes añadir tu email <em>@inlumine.ual.es</em> a la lista de emails de tu cuenta actual. Para ello, sigue las <a href="https://help.github.com/en/github/setting-up-and-managing-your-github-user-account/adding-an-email-address-to-your-github-account">instrucciones</a>. Tras añadir tu email, haz clic en el enlace <a href="https://education.github.com/benefits">Get the pack</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creación_de_la_infraestructura_en_google_cloud">2. Creación de la infraestructura en Google Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Utilizando una plantilla de terraform crea 2 instancias de máquina virtuales en tu proyecto en Google Cloud:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instancia para instalar Jenkins mediante un contenedor Docker.</p>
</li>
<li>
<p>Instancia de despliegue (VM Deploy) con Docker y Docker Composer instalados.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Utiliza la plantilla de terraform disponible en el repositorio <a href="https://github.com/ualcnsa/terraformGoogleCloudSample" class="bare">https://github.com/ualcnsa/terraformGoogleCloudSample</a>.</p>
</div>
<div class="paragraph">
<p>En primer lugar realiza un <em>fork</em> del repositorio, para hacer las modificaciones al mismo que sean necesarias. Después modifica las variables correspondientes para usar tu proyecto en la plantilla.</p>
</div>
<div class="sect2">
<h3 id="_estructura_del_proyecto_terraform">2.1. Estructura del proyecto terraform</h3>
<div class="paragraph">
<p>El repositorio consta de tres archivos con extension .tf, y una carpeta con un template para la creación de instancias.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>terraformGoogleCloudSample
├── instance
│   └── <strong>main.tf</strong> <i class="conum" data-value="4"></i><b>(4)</b>
├── .gitignore
├── README.md
├── <strong>mynetwork.tf</strong> <i class="conum" data-value="2"></i><b>(2)</b>
├── <strong>output.tf</strong> <i class="conum" data-value="3"></i><b>(3)</b>
└── <strong>provider.tf</strong> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Descripción del proveedor sobre el que ejecutar la plantilla, en nuestro caso Google Cloud.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Plantilla principal. Crea la red, las reglas de firewall, las 2 instancias llamando al <em>módulo</em> <code>main.tf</code> de la carpeta <code>instance</code>, y por último realiza la inicialización de cada instancia.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Plantilla con los valores que se muestran de salida al finalizar la ejecución</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Módulo genérico para crear una instancia. Es llamado desde <code>network.tf</code> pasándole las variables que necesita para crear la instancia.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El archivo <code><strong>provider.tf</strong></code> deberás modificarlo:</p>
</div>
<div class="listingblock">
<div class="title">provider.tf</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="tf"><span class="c1"># Descargar json con credenciales de aquí:</span>
<span class="c1"># https://console.cloud.google.com/apis/credentials/serviceaccountkey</span>
<span class="c1"># Tras ello definir la variable de entorno apuntando a el json</span>
<span class="c1"># export GOOGLE_CLOUD_KEYFILE_JSON=path/file.json</span>

<span class="k">variable</span> <span class="s2">"gcp_project"</span> <span class="p">{</span>
  <span class="c1"># Configurar el nombre del proyecto en GCP</span>
  <span class="nx">default</span> <span class="p">=</span> <span class="s2">"cnsa-2020"</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="p">}</span>

<span class="k">provider</span> <span class="s2">"google"</span> <span class="p">{</span>
  <span class="nx">project</span>     <span class="p">=</span> <span class="s2">"</span><span class="k">${</span><span class="kd">var</span><span class="p">.</span><span class="nx">gcp_project</span><span class="k">}</span><span class="s2">"</span>
  <span class="nx">region</span>      <span class="p">=</span> <span class="s2">"us-central1"</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sustituye este valor por el nombre de tu proyecto (<em>cnsa2020-abc123</em>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para que terraform pueda conectar al <em>provider</em> Google Cloud desde tu máquina local, debes proporcionar un archivo con credenciales. Descarga el archivo <code>.json</code> de aquí: <a href="https://console.cloud.google.com/apis/credentials/serviceaccountkey" class="bare">https://console.cloud.google.com/apis/credentials/serviceaccountkey</a></p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/crear-clave-cuenta-servicio.png" alt="crear clave cuenta servicio">
</div>
<div class="title">Fig. 1. Descarga de archivo de credenciales Google Cloud</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Selecciona el proyecto</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Selecciona la opción <em>Compute engine</em>, y pulsa <em>Crear</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Guarda el archivo .json en tu proyecto. A continuación, en tu terminal define la variable de entorno apuntando a el archivo recién descargado, sustituyendo <code>path/file.json</code> por la ruta relativa y el nombre del archivo de credenciales:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">export </span><span class="nv">GOOGLE_CLOUD_KEYFILE_JSON</span><span class="o">=</span><span class="k"><strong></span>path/file.json<span class="k"></strong></span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Recuerda <strong>no subir nunca tu archivo json de credenciales</strong> a un repositorio público como GitHub. Para ello, añade el nombre el archivo de credenciales  al <code>.gitignore</code>. En ese archivo va tu clave privada que sustituye a tu usuario y contraseña para crear recursos en GCP. Hay robots que continuamente buscan PRIVATE KEYS y API TOKENS en repositorios públicos como GitHub. Si un <em>hacker</em> accede a ese archivo, lo usará para crear servicios hasta gastar tu crédito por completo, fundamentalmente para minar bitcoins.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_ejecución_de_terraform">2.2. Ejecución de terraform</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Videotutorial</div>
<div class="paragraph">
<p>Accede al <a href="https://drive.google.com/file/d/1_ku2LnVbMmWgns-s8_23ATAQ3nrQEJo2/view?usp=sharing" target="_blank" rel="noopener">videotutorial</a> explicativo de esta sección (mp4, 20 minutos, 171M).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_terraform_init">2.2.1. <code>terraform init</code></h4>
<div class="paragraph">
<p>Una vez configurado el <em>provider</em> comprueba que la conexión es correcta: en tu terminal, ejecuta el comando <code>terraform init</code> para inicializar el proyecto como un proyecto terraform. Si todo es correcto aparecerá un mensaje de éxito.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/terraform-init-ok.png" alt="terraform init ok">
</div>
<div class="title">Fig. 2. <code>terraform init</code> correcto</div>
</div>
<div class="paragraph">
<p>Si por el contrario recibes algún mensaje de error, revisa el motivo del error:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Terraform puede que no esté accesible. Debería estar en el <code>PATH</code></p>
</li>
<li>
<p>Revisa si la variable de entorno si se ha guardado correctamente, ejecuta <code>echo $GOOGLE_CLOUD_KEYFILE_JSON</code> y comprueba que es la ruta y nombre de archivo correctos.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_terraform_plan">2.2.2. <code>terraform plan</code></h4>
<div class="paragraph">
<p>Ejecuta el comando <code>terraform plan</code> para ver el resultado de elementos que se crearán o eliminarán al ejecutar la plantilla. Debe aparecer que se crearán 7 elementos.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/terraform-plan-ok.png" alt="terraform plan ok">
</div>
<div class="title">Fig. 3. <code>terraform plan</code> correcto</div>
</div>
</div>
<div class="sect3">
<h4 id="_terraform_apply">2.2.3. <code>terraform apply</code></h4>
<div class="paragraph">
<p>Ejecuta el comando <code>terraform apply --auto-approve</code> para ejecutar la plantilla. Comenzará a crear los 7 elementos definidos en la plantilla. Tardará unos <strong>5 minutos</strong> así que ten paciencia. Sobre todo tardará en ejecutar los bloques de inicialización de las instancias, en las que se actualizan los paquetes, se instala Docker y otros paquetes. En todo momento verás en pantalla el <code>log</code> de las operaciones que se están realizando.</p>
</div>
<div class="paragraph">
<p>Comprueba que las instancias se han creado correctamente en tu proyecto Google Cloud.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Apaga las instancias</strong> cuando dejes de usarlas, para evitar que consuman crédito.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_terraform_destroy">2.2.4. <code>terraform destroy</code></h4>
<div class="paragraph">
<p>Cuando desees eliminar todos los recursos que hemos creado con esta plantilla, simplemente ejecuta <code>terraform destroy</code>. Por ahora debes simplemente apagar las instancias cuando no las uses, porque las necesitaremos en el resto de la asignatura.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cloud_dns">3. Cloud DNS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Google Cloud ha asignado una IP pública estática a cada una de tus instancias (la IP no cambiará al apagar la instancia y volver a encenderla). A continuación, vamos a asignar nombres de DNS a esas IPs con Cloud DNS y uno de los servicios de DNS disponibles en el Student Pack de GitHub.</p>
</div>
<div class="sect2">
<h3 id="_alta_de_nombre_de_dominio">3.1. Alta de nombre de dominio</h3>
<div class="paragraph">
<p>GitHub Student pack ofrece varios servicios de nombres dominios gratuitos durante 1 año. Puedes usar <em>name.com</em>, <em>namecheap</em>, o <em>.tech domains</em>. En uno de ellos vamos a dar de alta un nombre de dominio para nuestras instancias en Google Cloud. Voy a describir cómo hacerlo con <strong>.tech</strong>.</p>
</div>
<div class="paragraph">
<p>Accede a <a href="https://get.tech/github-student-developer-pack">get.tech</a> y prueba un nombre de dominio que te guste y que esté disponible.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/tech-domain-disponible.png" alt="tech domain disponible">
</div>
<div class="title">Fig. 4. Comprobar si el dominio está disponible en get.tech</div>
</div>
<div class="paragraph">
<p>A continuación, inicia sesión con tu cuenta de github, y verás que tienes el descuento por un año. Procede a la compra gratuita. Además, tendrás que registrarte para poder acceder posteriormente a la configuración. Debes completar los datos de registro ya que te identifican como propietario del nombre de dominio. Si lo deseas, usa como dirección <em>Universidad de Almería, Ctra. Sacramento s/n, 04120, Almería, Spain</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_de_nombres_de_dominio">3.2. Configuración de nombres de dominio</h3>
<div class="paragraph">
<p>Para configurar el nombre de dominio que acabas de adquirir a las IPs reservadas, debes usar Cloud DNS en Google Cloud. Cloud DNS permite asignar los nombres de dominio a las direcciones IP públicas de las instancias. Recuerda comprobar que las IPs son estáticas.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En el menú de la consola de Google Cloud, entra en <strong>Servicios de red</strong>, <strong>Cloud DNS</strong>.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/cloud-dns.png" alt="cloud dns" width="360">
</div>
<div class="title">Fig. 5. Cloud DNS</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Haz clic en <strong>Crear Zona</strong>.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/cloud-dns-crear-zona.png" alt="cloud dns crear zona">
</div>
<div class="title">Fig. 6. Cloud DNS, crear zona</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>A continuación, haz clic en <strong>Añadir Conjunto de registros</strong>. Para cada instancia, crea un conjunto de registros.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/cloud-dns-crear-conjunto-de-registros.png" alt="cloud dns crear conjunto de registros">
</div>
<div class="title">Fig. 7. Cloud DNS. Crear conjunto de registros, instancia Jenkins</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/cloud-dns-crear-conjunto-de-registros2.png" alt="cloud dns crear conjunto de registros2">
</div>
<div class="title">Fig. 8. Cloud DNS. Crear conjunto de registros, instancia de despliegue de apps</div>
</div>
<div class="paragraph">
<p>Tras la creación, debes tener un resultado similar a este:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/cloud-dns-detalles-zona.png" alt="cloud dns detalles zona">
</div>
<div class="title">Fig. 9. Cloud DNS. Detalles de la Zona</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>El último paso será modificar los servidores de DNS de la configuración en la web .tech, para poner los valores de los servidores de Google Cloud. Para ello, inicia sesión en get.tech. Entra en tu pedido.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/get-tech-manage-orders.png" alt="get tech manage orders">
</div>
<div class="title">Fig. 10. get.tech. Acceso al pedido</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Modifica los nombres de los servidores con los valores de tu zona en Cloud DNS</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/get-tech-manage-servers.png" alt="get tech manage servers">
</div>
<div class="title">Fig. 11. get.tech. Nombres de los servidores</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Guarda los cambios. Hasta <strong>pasadas 24 horas</strong> no estarán disponibles.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instalación_de_jenkins">4. Instalación de Jenkins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vamos a usar la primera instancia para instalar Jenkins. En lugar de realizar una <a href="https://github.com/ualhmis/Jenkins2Instalacion/blob/master/jenkins2_2019.adoc">instalación completa sobre el sistema operativo</a>, utilizando los paquetes de Ubuntu, tal como se hace en la asignatura Herramientas y Métodos de Ingeniería del Software, de 3º del Grado en Ingeniería Informática, aquí vas a desplegar Jenkins como un contenedor de  docker.</p>
</div>
<div class="sect2">
<h3 id="_construcción_de_la_imagen_del_contenedor_jenkins">4.1. Construcción de la imagen del contenedor Jenkins</h3>
<div class="paragraph">
<p>La imagen pública del contenedor de Jenkins está disponible en <a href="https://hub.docker.com/_/jenkins/">DockerHub</a>. Esta imagen genérica necesita instalarle algunos plugins y herramientas. En concreto, hay que instalarle el propio Docker para permitir que Jenkins ejecute tareas de docker, como por ejemplo <code>docker build</code> para construir imágenes de contenedores.</p>
</div>
<div class="paragraph">
<p>Por tanto, vamos a crear una imagen personalizada del contenedor de Jenkins basándonos en la imagen pública e instalándo Docker dentro del contenedor.
Lo más adecuado es que construyas la imagen de Jenkins con Docker en la propia máquina donde lo vamos a ejecutar, es decir en la instancia de jenkins.</p>
</div>
<div class="paragraph">
<p>Conecta por ssh a la instancia. Crea una carpeta <code>jenkins-docker</code> y crea el archivo <code>Dockerfile</code>. Usa el siguiente Dockerfile (descrito en esta entrada de <em>medium.com</em>:  <a href="https://medium.com/@gustavo.guss/jenkins-building-docker-image-and-sending-to-registry-64b84ea45ee9">Jenkins Building Docker Image and Sending to Registry</a>.</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="k">FROM</span><span class="s"> jenkins/jenkins:lts</span>

<span class="k">USER</span><span class="s"> root</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>apt-get <span class="nt">-y</span> <span class="nb">install </span>apt-transport-https <span class="se">\
</span>    ca-certificates <span class="se">\
</span>    curl <span class="se">\
</span>    gnupg2 <span class="se">\
</span>    software-properties-common <span class="o">&amp;&amp;</span> <span class="se">\
</span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/<span class="si">$(</span><span class="nb">.</span> /etc/os-release<span class="p">;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$ID</span><span class="s2">"</span><span class="si">)</span>/gpg <span class="o">&gt;</span> /tmp/dkey<span class="p">;</span> apt-key add /tmp/dkey <span class="o">&amp;&amp;</span> <span class="se">\
</span>add-apt-repository <span class="se">\
</span>    <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/</span><span class="si">$(</span><span class="nb">.</span> /etc/os-release<span class="p">;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$ID</span><span class="s2">"</span><span class="si">)</span><span class="s2"> </span><span class="se">\
</span><span class="s2">    </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> </span><span class="se">\
</span><span class="s2">    stable"</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>  apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>  apt-get <span class="nt">-y</span> <span class="nb">install </span>docker-ce

<span class="k">RUN </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> docker-ce

<span class="k">RUN </span>usermod <span class="nt">-a</span> <span class="nt">-G</span> docker jenkins

<span class="k">USER</span><span class="s"> jenkins</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Construimos la imagen a partir del Dockerfile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker build <span class="nt">--tag</span> <span class="k"><strong></span>ualjjcanada<span class="k"></strong></span>/jenkins-docker:1.0 <span class="nb">.</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sustituye <strong>ualjjcanada/</strong> por tu usuario de Dockerhub si estás registrado, si no simplemente no lo pongas.</td>
</tr>
</table>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/docker-build-tag.png" alt="docker build tag">
</div>
<div class="title">Fig. 12. <code>docker build</code> de Jenkins con Docker</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/docker-build-tag-successfully.png" alt="docker build tag successfully">
</div>
<div class="title">Fig. 13. <code>docker build</code> successful</div>
</div>
<div class="paragraph">
<p>Comprueba que la imagen ha sido creada, y está disponible en tu máquina: <code>docker image ls</code></p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/docker-image-ls.png" alt="docker image ls">
</div>
<div class="title">Fig. 14. <code>docker image ls</code></div>
</div>
</div>
<div class="sect2">
<h3 id="_publicación_en_google_container_registry">4.2. Publicación en Google Container Registry</h3>
<div class="paragraph">
<p>Opcionalmente podemos publicar nuestra imagen personalizada en DockerHub, o alternativamente el Google Container Registry. Más adelante se describirá cómo hacerlo.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ejecución_del_contenedor_de_jenkins">4.3. Ejecución del contenedor de Jenkins</h3>
<div class="paragraph">
<p>Ejecutamos el contenedor a partir de la imagen creada previamente.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear una carpeta para <code>jenkins_home</code> que configuraremos como volumen para que los datos de Jenkins se guarden fuera del contenedor.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">mkdir</span> ~/jenkins_home
<span class="nb">chmod </span>777 ~/jenkins_home</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Ejecutamos el contenedor con <code>docker run</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker run <span class="nt">-d</span> <span class="nt">--name</span> jenkins-docker <span class="nt">-p</span> 80:8080 <span class="nt">-p</span> 50000:50000 <span class="nt">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class="nt">-v</span> ~/jenkins_home:/var/jenkins_home <span class="nt">--restart</span> always ualjjcanada/jenkins-docker:1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los parámetros de <code>docker run</code> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--name jenkins-docker</code>: nombre que le asignamos al contenedor</p>
</li>
<li>
<p><code>-p 80:8080</code>: jenkins se ejecutará en el puerto 80 en el host, que está mapeado al puerto 8080 del contenedor</p>
</li>
<li>
<p><code>-v /var/run/docker.sock:/var/run/docker.sock</code>: volumen para compartir el docker socket (usando en tu máquina) con el contenedor.</p>
</li>
<li>
<p><code>-v ~/jenkins_home:/var/jenkins_home</code>: mapea la carpeta local <code>~/jenkins_home</code> con la carpeta <code>/var/jenkins_home</code> del contenedor. En el contenedor, la carpeta HOME del usuario <em>jenkins</em> es <code>/var/jenkins_home</code>, donde Jenkins guarda todos los archivos que utiliza. Si se tira el contenedor o se actualiza, no se pierden los datos ya que se guardan "fuera" del contenedor.</p>
</li>
<li>
<p><code>--restart always</code>: inicia el contenedor cuando se enciende la instancia.</p>
</li>
<li>
<p><code>ualjjcanada/jenkins-docker:1.0</code>: imagen del contenedor a ejecutar, la que hemos construido en el paso anterior.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Comprueba que el contenedor está ejecutándose con <code>docker ps</code></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/docker-ps-jenkins.png" alt="docker ps jenkins">
</div>
<div class="title">Fig. 15. <code>docker ps</code></div>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_básica_de_jenkins">4.4. Configuración básica de Jenkins</h3>
<div class="paragraph">
<p>A continuación se muestran los pasos a realizar en el inicio y configuración básica de Jenkins. Además, se describe la instalación de algunos plugins adicionales.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Conectamos a la IP/URL de la instancia con el navegador web. Aparecerá la ventana para introducir el password inicial. Para ver el password ejecuta: <code>cat /home/ubuntu/jenkins_home/secrets/initialAdminPassword</code></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-unlock.png" alt="jenkins unlock">
</div>
<div class="title">Fig. 16. Contraseña inicial de Jenkins</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Selecciona Install suggested plugins.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-install-suggested-plugins.png" alt="jenkins install suggested plugins">
</div>
<div class="title">Fig. 17. Install suggested plugins</div>
</div>
<div class="paragraph">
<p>Tras unos minutos, introduce los datos del  usuario administrador de Jenkins. Introduce un nombre de usuario y contraseña.</p>
</div>
<div class="paragraph">
<p>Acepta el nombre de dominio de la máquina. Si aun no has registrado el nombre de dominio, lo puedes hacer más tarde en la configuración general de Jenkins.</p>
</div>
<div class="paragraph">
<p>Jenkins está listo.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-welcome.png" alt="jenkins welcome">
</div>
<div class="title">Fig. 18. Bienvenida a Jenkins</div>
</div>
</div>
<div class="sect2">
<h3 id="_creación_del_primer_proyecto_jenkins">4.5. Creación del primer proyecto Jenkins</h3>
<div class="paragraph">
<p>Creamos el primer proyecto de Jenkins. Comprueba que Jenkins puede llamar a docker. Para ello crea un nuevo proyecto tipo freestyle.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-new-hello-docker.png" alt="jenkins new hello docker">
</div>
<div class="title">Fig. 19. Nuevo proyecto, freestyle</div>
</div>
<div class="paragraph">
<p>En la sección <strong>Build</strong>, añade un bloque <strong>Execute shell</strong>. Pega estos comandos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">whoami
</span>git <span class="nt">--version</span>
java <span class="nt">-version</span>
docker <span class="nt">-v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Guarda los cambios. Haz clic sobre <strong>Build now</strong>. Haz clic sobre la bolita azul para ver el la salida por consola.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-new-hello-docker-console-output.png" alt="jenkins new hello docker console output">
</div>
<div class="title">Fig. 20. Build now. Resultado del build</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-new-hello-docker-console-success.png" alt="jenkins new hello docker console success">
</div>
<div class="title">Fig. 21. Salida por consola</div>
</div>
<div class="paragraph">
<p>Por consola se visualiza el resultado de ejecutar los comandos dentro del contenedor. Como puedes ver, <code>git</code> y <code>java</code> están instalados, venían ya en la imagen de jenkins:lts de la que hemos partido en la definición del Dockerfile. Además, <code>docker</code> también está disponible, se ha instalado correctamente mediante la definición incluida en el Dockerfile.</p>
</div>
</div>
<div class="sect2">
<h3 id="_instalación_de_plugins_adicionales">4.6. Instalación de plugins adicionales</h3>
<div class="paragraph">
<p>Vamos a instalar varios plugins: greenballs, NodeJs, GitHub integration.</p>
</div>
<div class="paragraph">
<p>Haz clic en <em>Manage Jenkins</em> &gt; <em>Manage Plugins</em>. En la pestaña <em>Available</em> busca <em>Github integration</em>, seleccionaló y pulsa en <em>Download now and install after restart</em>.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-plugins-github-integration.png" alt="jenkins plugins github integration">
</div>
<div class="title">Fig. 22. Instalación del plugin Github integration</div>
</div>
<div class="paragraph">
<p>Repite los pasos para los plugins <em>Green Balls</em> y  <em>NodeJS</em>.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-plugins-nodejs.png" alt="jenkins plugins nodejs">
</div>
<div class="title">Fig. 23. Instalación del plugin NodeJS</div>
</div>
<div class="paragraph">
<p>Marca <em>Restart Jenkins</em> para completar la instalación. Tras unos segundos, vuelve a iniciar sesión y tendrás los plugins instalados.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-plugins-restart.png" alt="jenkins plugins restart">
</div>
<div class="title">Fig. 24. Reiniciar para completar la instalación</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_las_tools_en_jenkins">4.7. Configuración las tools en Jenkins</h3>
<div class="paragraph">
<p>Tras la instalación del plugin <a href="https://plugins.jenkins.io/nodejs/"><em>NodeJS</em></a>, es necesario realizar la siguiente configuración:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ve a <em>Manage Jenkins</em>, <em>Global Tool configuration</em>.</p>
</li>
<li>
<p>En <strong>NodeJS</strong>, añade un instalador. Dale por nombre "nodejs" y marca instalar automáticamente.</p>
</li>
<li>
<p>Guarda los cambios.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-tool-nodejs.png" alt="jenkins tool nodejs">
</div>
<div class="title">Fig. 25. Configuración de herramienta NodeJS</div>
</div>
<div class="paragraph">
<p>De la misma forma, instala la última versión de Maven.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conexión_con_la_máquina_de_despliegue">4.8. Conexión con la máquina de despliegue</h3>
<div class="paragraph">
<p>Para realizar el despliegue, deberás permitir que Jenkins ejecute unos comandos en la máquina de despliegue. Para ello, la instancia Jenkins debe poder conectarse a la instancia de despliegue mediante una conexión SSH basada en autenticación por pareja de claves pública/privada, que ha demostrado ser más seguro sobre la autenticación estándar de nombre de usuario/contraseña.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/deploy-schema-full.png" alt="deploy schema full">
</div>
<div class="title">Fig. 26. Esquema de despliegue con Jenkins</div>
</div>
<div class="paragraph">
<p>Para ello, los pasos que se detallan a continuación permiten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>generar una nueva pareja de claves que usaremos para el despliegue,</p>
</li>
<li>
<p>copiar la clave pública generada en la instancia de despliegue,</p>
</li>
<li>
<p>y por último probar que la conexión se realiza correctamente.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ejecuta los siguientes pasos:</p>
</div>
<div class="sect3">
<h4 id="_generar_la_nueva_pareja_de_claves_de_despliegue">4.8.1. Generar la nueva pareja de claves de despliegue</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Conecta por SSH a la máquina Jenkins: <code>ssh ubuntu@<em>instancia-jenkins</em></code></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/ssh-from-developer-to-jenkins.png" alt="ssh from developer to jenkins">
</div>
<div class="title">Fig. 27. Conexión SSH a la instancia Jenkins</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Crea la carpeta donde se va a guardar la nueva pareja de claves: <code>mkdir /home/ubuntu/jenkins_home/.ssh</code></p>
</li>
<li>
<p>Crea una pareja de claves ssh de despliegue: <code>ssh-keygen -t rsa -b 4096</code></p>
</li>
<li>
<p>Cuando pida el <strong>nombre</strong>, escribe el nuevo nombre <strong>id_rsa_deploy</strong> junto con la ubicación donde Jenkins va a buscar las claves de forma predeterminada, que es: <code>/home/ubuntu/jenkins_home/.ssh/<strong>id_rsa_deploy</strong></code></p>
</li>
<li>
<p>Por último, deja la contraseña en blanco (pulsa ENTER): <code>Enter passphrase (empty for no passphrase):</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Esto crea la clave privada en <code>/home/ubuntu/jenkins_home/.ssh/<strong>id_dsa_deploy</strong></code> y una clave pública asociada en <code>/home/ubuntu/jenkins_home/.ssh/<strong>id_dsa_deploy.pub</strong></code>. Esta nueva pareja de claves la usaremos exclusivamente para el despliegue de nuestros proyectos. Al haberlos guardado en la carpeta <code>/home/ubuntu/jenkins_home/</code> los archivos están accesibles dentro del contenedor, porque recuerda que esa carpeta la habíamos mapeado con la carpeta <code>/var/jenkins_home</code> del contenedor.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-ls-deploy-keys.png" alt="jenkins ls deploy keys">
</div>
<div class="title">Fig. 28. Pareja de claves <em>id_rsa_deploy</em></div>
</div>
</div>
<div class="sect3">
<h4 id="_copiar_la_clave_pública_a_la_instancia_de_despliegue">4.8.2. Copiar la clave pública a la instancia de despliegue</h4>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Muestra el contenido de la clave pública: <code>cat /home/ubuntu/jenkins_home/.ssh/id_rsa_deploy.pub</code></p>
</li>
<li>
<p>Copia el contenido: con el ratón, selecciona el contenido de la clave, desde “ssh-rsa” hasta el final, y pulsa ENTER (o CTRC+C)</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-cat-public-key.png" alt="jenkins cat public key">
</div>
<div class="title">Fig. 29. Copia el contenido de <em>id_rsa_deploy.pub</em></div>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>Ahora pégalo en tu PC, lo necesitaremos más adelante.</p>
</li>
<li>
<p>Desconecta de la máquina Jenkins: <code>exit</code></p>
</li>
<li>
<p>Conecta por ssh a la instancia de despliegue</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/ssh-from-developer-to-deploy.png" alt="ssh from developer to deploy">
</div>
<div class="title">Fig. 30. Conexión SSH a la instancia Jenkins</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>Edita el archivo <code>authorized_keys</code>:  <code>nano home/ubuntu/.ssh/authorized_keys</code></p>
</li>
<li>
<p>Ese archivo ya tenía una clave pública, la correspondiente a tu pareja de claves personal que inyectamos en la creación de la instancia con Terraform (por eso has podido conectar por ssh a esa máquina). Pega el contenido de la clave pública de despliegue. Ahora debe tener 2 claves públicas.</p>
</li>
<li>
<p>Ya puedes desconectar de la instancia de despliegue.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_prueba_de_la_conexión_desde_jenkins_a_despliegue">4.8.3. Prueba de la conexión desde jenkins a despliegue</h4>
<div class="paragraph">
<p>Vamos a probar que funciona:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-ssh-to-deploy.png" alt="jenkins ssh to deploy">
</div>
<div class="title">Fig. 31. Conexión SSH desde la instancia Jenkins a la de despliegue</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p>Conecta de nuevo a la instancia jenkins y prueba la conexión ssh a la instancia de despliegue. Recuerda que puesto que Jenkins se está ejecutando como un contenedor, debes probar la conexión ssh desde dentro del contenedor:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker <span class="nb">exec</span> <span class="nt">-it</span> jenkins-docker ssh ubuntu@<em>instancia_deploy</em> <span class="nt">-i</span> /var/jenkins_home/.ssh/id_rsa_deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>En el comando anterior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>docker exec -it</code> indica ejecutar un comando desde dentro del contenedor</p>
</li>
<li>
<p><code>jenkins-docker</code> es el nombre del contenedor</p>
</li>
<li>
<p><code>ssh ubuntu@<em>instancia_deploy</em> -i /var/jenkins_home/.ssh/id_rsa_deploy</code> es el comando a ejecutar en el contenedor. En este caso, <code>ssh</code> con el parámetro <code>-i &#8230;&#8203;</code> para indica la clave privada que debe usar para conectar.</p>
</li>
<li>
<p>Recuerda que <code>/var/jenkins_home</code> es la carpeta HOME del usuario <em>jenkins</em> dentro del contenedor, y <em>jenkins</em> es el usuario del contenedor que ejecuta Jenkins.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p>La primera vez que realizas una conexión ssh desde un usuario en una máquina origen a una destino, te pregunta si deseas almacenar la clave de host de destino en la lista de hosts conocidos (<code>known_hosts</code>) de tu máquina origen. Contesta: <code>yes</code></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/ssh-host-autentication.png" alt="ssh host autentication">
</div>
<div class="title">Fig. 32. Validar la clave del host: <strong>yes</strong></div>
</div>
<div class="olist arabic">
<ol class="arabic" start="16">
<li>
<p>Si todo ha ido bien, la conexión se ha debido realizar. Sal con <code>exit</code>. Si no ha sido así, verifica que la ruta al archivo de la clave privada es correcta, y que el nombre de la máquina de despliegue es correcto.</p>
</li>
<li>
<p>Comprueba que la clave de host de la máquina de destino (despliegue) se ha guardado en la máquina origen (jenkins) en el archivo <code>~/.ssh/known_hosts</code> del usuario que ha ejecutado el comando ssh, en nuestro caso, del usuario jenkins de contenedor: <code>docker exec -it jenkins-docker cat /var/jenkins_home/.ssh/known_hosts</code></p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/ssh-known_hosts.png" alt="ssh known hosts">
</div>
<div class="title">Fig. 33. Contenido del archivo <strong>known_hosts</strong> en el contenedor</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="18">
<li>
<p>Puedes comprobar también el contenido de <em>known_hosts</em> en el archivo <code>/home/ubuntu/jenkins_home/.ssh/known_hosts</code>, ya que recuerda que hay un volumen mapeado entre la carpeta local <code>/home/ubuntu/jenkins_home</code> y la carpeta del contenedor <code>/var/jenkins_home</code>.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/ssh-known_hosts-local.png" alt="ssh known hosts local">
</div>
<div class="title">Fig. 34. Contenido del archivo <strong>known_hosts</strong> en la carpeta local</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="19">
<li>
<p>Entra en Jenkins y añade el siguiente comando al proyecto <em>hello_docker</em> existente, sustituyendo <em>MAQUINA_DEPLOY</em> por el nombre DNS de la máquina de despliegue.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">ssh <span class="nt">-i</span> ~/.ssh/id_rsa_deploy ubuntu@MAQUINA_DEPLOY <span class="s2">"pwd &amp;&amp; ls -la"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Como aclaración de este comando:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>el parámetro <code>-i</code> indica la clave privada que queremos usar en la conexión ssh</p>
</li>
<li>
<p><code>"pwd &amp;&amp; ls -la"</code> son comandos básicos que ejecuta sobre la máquina remota. Hemos indicado estos comandos simplemente para probar que la conexión se realiza correctamente.</p>
</li>
</ul>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenksin-hello-docker-ssh-to-deploy.png" alt="jenksin hello docker ssh to deploy">
</div>
<div class="title">Fig. 35. Modificación del proyecto para que ejecute un comando sobre la instancia de despliegue</div>
</div>
<div class="paragraph">
<p>Tras ejecutar el proyecto en Jenkins, el resultado debe ser correcto.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenksin-hello-docker-ssh-to-deploy-output.png" alt="jenksin hello docker ssh to deploy output">
</div>
<div class="title">Fig. 36. Salida por consola. El comando se ha ejecutado correctamente.</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ejemplo_1_aplicación_web_java">5. Ejemplo 1: Aplicación web Java.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una vez que hemos configurado correctamente nuestro entorno de CI/CD con Jenkins, vamos a estudiar varios ejemplos tanto en Java como en NodeJs.</p>
</div>
<div class="paragraph">
<p>En este primer ejemplo en Java, nos vamos a basar en el proyecto PetClinic con Spring Boot, disponible en <a href="https://github.com/spring-projects/spring-petclinic">GitHub</a>. Petclinic es una aplicación <a href="https://spring.io/guides/gs/spring-boot">Spring Boot</a> construida usando <a href="https://spring.io/guides/gs/maven/">Maven</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://es.wikipedia.org/wiki/Spring_Framework">Spring Boot</a> es un framework de código abierto para el desarrollo de aplicaciones Java basadas en <a href="https://spring.io/">Spring</a>. Spring Boot genera una proyecto Maven/Gradle con todo lo necesario y que se autoconfigura en el arranque. Por ejemplo, si decimos que queremos una aplicación web, Spring Boot automáticamente  embebe un Tomcat y lo configura con el servlet de Spring. Toda la configuración la añade al archivo de la herramienta de build <em>build</em> que indiquemos, en caso de Maven, al archivo <code>pom.xml</code>.</p>
</div>
<div class="paragraph">
<p>Recordemos que <strong>Maven</strong> es una herramienta software para la gestión y construcción de proyectos Java. <a href="https://maven.apache.org/">Apache Maven</a> estandariza la configuración de un proyecto en todo su ciclo de vida, como son todas las fases de compilación, ejecución de pruebas, empaquetado, etc. Maven permite la gestión de dependencias entre módulos y distintas versiones de librerías, simplemente indicando los módulos que componen el proyecto, y las dependencias utiliza el software que estamos desarrollando, en un fichero XML de configuración  llamado POM (Project Object Model).</p>
</div>
<div class="paragraph">
<p>Para el proyecto PetClinic, en tu máquina de desarrollo local puedes construir el .jar (empaquetado) y ejecutar Petclinic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">git clone https://github.com/spring-projects/spring-petclinic.git
<span class="nb">cd </span>spring-petclinic
./mvnw package <i class="conum" data-value="1"></i><b>(1)</b>
java <span class="nt">-jar</span> target/<span class="k">*</span>.jar <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Llama al <em>warper</em> de Maven que instala Maven (si es necesario), y ejecuta el <em>goal</em> <code><strong>package</strong></code> que se encarga de compilar, ejecutar los test y empaquetar la aplicación en un único archivo ejecutable <code>.jar</code>. La primera vez que lances la construcción tardará más de 5 minutos, ya que tiene que descargar todas las dependencias necesarias desde los repositorios de Maven (Maven Central), y después lanzar los tests. Toda la configuración necesaria está contenida en el archivo <code>pom.xml</code> de Maven.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ejecuta la aplicación a partir del <code>.jar</code>. Puedes acceder a PetClinic en: <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a></td>
</tr>
</table>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/petclinic-homepage.png" alt="petclinic homepage">
</div>
<div class="title">Fig. 37. Página principal de PetClinic</div>
</div>
<div class="paragraph">
<p>En su configuración predeterminada, Petclinic utiliza una base de datos en memoria (H2) que se inicia con datos predeterminados, y los nuevos datos que se guarden se pierden al reiniciar la aplicación.</p>
</div>
<div class="paragraph">
<p>En caso de necesitar persistencia de los datos, PetClinic también está preconfigurada para usar MySql. Para cambiar el tipo de base de datos, la aplicación debe ejecutarse con un perfil de MySql: <code>spring.profiles.active=mysql</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">java <span class="nt">-Dspring</span>.profiles.active<span class="o">=</span>mysql <span class="nt">-jar</span> target/<span class="k">*</span>.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recuerda que para ejecutarla en este modo, debes tener un MySql funcionando en local, o bien lanzar MySql como contenedor con <strong>docker</strong> o con <strong>docker-compose</strong>. Existe un archivo <code>docker-compose.yml</code> disponible en el proyecto, por tanto puedes iniciar MySql así:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker-compose up <span class="nt">-d</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El archivo <code>docker-compose.yml</code> que permite iniciar MySql puedes consultarlo en la carpeta raíz del proyecto, y es el siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yml"><span class="na">mysql</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:5.7</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">3306:3306"</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">MYSQL_ROOT_PASSWORD=</span>
    <span class="pi">-</span> <span class="s">MYSQL_ALLOW_EMPTY_PASSWORD=true</span>
    <span class="pi">-</span> <span class="s">MYSQL_USER=petclinic</span>
    <span class="pi">-</span> <span class="s">MYSQL_PASSWORD=petclinic</span>
    <span class="pi">-</span> <span class="s">MYSQL_DATABASE=petclinic</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">./conf.d:/etc/mysql/conf.d:ro"</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_creación_de_proyecto_jenkins_con_pipelines">5.1. Creación de proyecto Jenkins con pipelines</h3>
<div class="paragraph">
<p>Una vez que hemos probado la ejecución y funcionamiento de la aplicación PetClinic en local, vamos a configurar el proyecto en el servidor Jenkins de CI/CD para que este se encargue de  la construcción y el despliegue automatizados.</p>
</div>
<div class="paragraph">
<p>Conecta a tu Jenkins, y crea un nuevo item de tipo Pipeline. Dale el nombre 'spring-petclinic-pipeline':</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/new-item-pipeline-petclinic.png" alt="new item pipeline petclinic">
</div>
<div class="title">Fig. 38. New Item, PetClinic pipeline</div>
</div>
<div class="paragraph">
<p>En el bloque Pipeline, pega la configuración siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">agent</span> <span class="n">any</span> <i class="conum" data-value="1"></i><b>(1)</b>

  <span class="n">tools</span> <span class="o">{</span>
    <span class="c1">// Previamente has debido instalar Maven con el nombre "Default Maven"</span>
    <span class="n">maven</span> <span class="s2">"Default Maven"</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="o">}</span>

  <span class="n">stages</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="n">stage</span><span class="o">(</span><span class="s1">'Git fetch'</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="c1">// Get some code from a GitHub repository</span>
        <span class="n">git</span> <span class="s1">'https://github.com/spring-projects/spring-petclinic.git'</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">'Compile, Test, Package'</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="5"></i><b>(5)</b>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="c1">// Run goal 'package' includes compile, test and package.</span>
        <span class="n">sh</span> <span class="s2">"mvn clean package"</span>
      <span class="o">}</span>
      <span class="n">post</span> <span class="o">{</span> <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="c1">// If Maven was able to run the tests, even if some of the test</span>
        <span class="c1">// failed, record the test results and archive the jar file.</span>
        <span class="n">success</span> <span class="o">{</span>
          <span class="n">junit</span> <span class="s1">'**/target/surefire-reports/TEST-*.xml'</span>
          <span class="n">archiveArtifacts</span> <span class="s1">'target/*.jar'</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>agente o nodo de Jenkins en que ejecuta la construcción del  proyecto. En el ejemplo, <code>any</code> indica que se ejecutará cualquier nodo, en nuestro caso será en <em>master</em> ya que es el único nodo que hay definido en nuestro Jenkins.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>como herramienta para la construcción se usará maven. Pon aquí el nombre que diste a tu instalación de Maven configurada previamente en Tools Configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Bloque de <code>stages</code>: fases o etapas que conforman el pipeline</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Fase de descarga del repositorio git</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Fase de compilación, ejecución de test y empaquetado de la aplicación. Se realizarán con los <em>goals</em> <code>clean package</code>: primero se elimina todo lo generado en la construcción anterior, y a continuación se lanza la construcción con <code>package</code> tal y como está definida en el archivo <code>pom.xml</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Paso posterior que guarda los resultados de los test de JUnit para generar la gráfica de evolución de los test.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras ejecutar el pipeline, con "Build now", el resultado debe ser el siguiente:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/petclinic-pipeline-build-1.png" alt="petclinic pipeline build 1">
</div>
<div class="title">Fig. 39. Construcción del pipeline PetClinic</div>
</div>
<div class="paragraph">
<p>Si realizamos una segunda ejecución, ya aparecerá la gráfica de evolución de los tests de JUnit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_informe_de_cobertura_de_código">5.2. Informe de Cobertura de código</h3>
<div class="paragraph">
<p>Jenkins nos permite publicar métricas asociadas al proyecto. Una de ellas, es la cobertura de código ejecutado por las pruebas.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>La <strong>Cobertura</strong> de código nos indica el porcentaje de código de producción que está siendo ejecutado por los test. Es deseable tener un valor de cobertura lo más próximo posible al 100%</p>
</div>
</div>
</div>
<div class="paragraph">
<p>El proyecto PetClinic contiene 40 test unitarios en JUnit, y está configurado (ver <code>pom.xml</code>) para que se calcule la cobertura cuando se lanzan los tests mediante el plugin JaCoCo (Java Code Coverage). Puedes visualizar el resultado de la cobertura en tu construcción local, en la carpeta <code>target/site/jacoco</code>:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jacoco-local-results.png" alt="jacoco local results">
</div>
<div class="title">Fig. 40. Archivos generados por Jacoco</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jacoco-local-html.png" alt="jacoco local html">
</div>
<div class="title">Fig. 41. Informe html de la cobertura Jacoco</div>
</div>
<div class="paragraph">
<p>Y si haces clic en el nombre de una clase, verás el código coloreado:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/plugins-jacoco-class-details.png" alt="plugins jacoco class details">
</div>
<div class="title">Fig. 42. Detalle la cobertura de las lineas de código</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Las lineas <span class="lime-background">verdes</span> están cubiertas, es decir, han sido ejecutadas por al menos 1 test.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Las lineas <span class="yellow-background">amarillas</span> están parcialmente cubiertas (<em>missed branches</em>): un resultado de la condición (verdadero/falso) ha sido ejecutado por algún test pero el otro no ha sido ejecutado por ningún test.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Las líneas <span class="red-background">rojas</span> no están cubiertas, no han sido ejecutadas por ningún test.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para visualizar el resultado de la cobertura en Jenkins:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instala el plugin de Jacoco y el plugin Code Coverage API</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/plugins-jacoco-install.png" alt="plugins jacoco install">
</div>
<div class="title">Fig. 43. Instalación del plugin Jacoco</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/plugins-code-coverage-api-install.png" alt="plugins code coverage api install">
</div>
<div class="title">Fig. 44. Instalación del plugin Code Coverage API</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Añade las dos siguientes lineas al bloque <code>post</code> para que se guarde y muestre el informe de cobertura.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">  <span class="o">...</span>
  <span class="n">success</span> <span class="o">{</span>
    <span class="n">junit</span> <span class="s1">'**/target/surefire-reports/TEST-*.xml'</span>
    <span class="n">archiveArtifacts</span> <span class="s1">'target/*.jar'</span>
    <span class="n">jacoco</span><span class="o">(</span><span class="nl">execPattern:</span> <span class="s1">'target/jacoco.exec'</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="n">publishCoverage</span> <span class="nl">adapters:</span> <span class="o">[</span><span class="n">jacocoAdapter</span><span class="o">(</span><span class="s1">'target/site/jacoco/jacoco.xml'</span><span class="o">)]</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="o">}</span>
  <span class="o">...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añade el informe Coverage Trend</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Añade el informe Coverage Report</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tras la construcción de nuevo del proyecto, verás la gráfica de los resultados de los test y debajo la gráfica de evolución de cobertura:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/plugins-jacoco-dashboard-result.png" alt="plugins jacoco dashboard result">
</div>
<div class="title">Fig. 45. Informe de cobertura en el dashboard</div>
</div>
<div class="paragraph">
<p>Haciendo clic sobre la gráfica accedes a los detalles:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/plugins-jacoco-details-result.png" alt="plugins jacoco details result">
</div>
<div class="title">Fig. 46. Detalle de de cobertura</div>
</div>
</div>
<div class="sect2">
<h3 id="_análisis_estático_de_código_checkstyle">5.3. Análisis estático de código: <em>Checkstyle</em></h3>
<div class="paragraph">
<p>Para mantener y aumentar la calidad de nuestro código debemos ayudarnos, entre otras herramientas, de técnicas de <a href="https://es.wikipedia.org/wiki/An%C3%A1lisis_est%C3%A1tico_de_software"><strong>análisis estático de código</strong></a>. Básicamente, se encargan de buscar defectos en el código sin necesidad de que este se ejecute. En Java una de las más habituales es <a href="https://checkstyle.sourceforge.io/">Checkstyle</a>, aunque hay otras como FindBugs, PMD, y SonarQube que integra a los anteriores.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>CheckStyle</strong> valida el estilo del código respecto al estilo oficial de Java.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>El proyecto PetClinic tiene configurado el plugin de CheckStyle en el <code>pom.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    ...
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-checkstyle-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
        ...
      <span class="nt">&lt;/plugin&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para ejectutar CheckStyle en local, ejecuta el comando de maven (<code>mvn</code>) con los siguietnes <em>goals</em>: <code>mvn checkstyle:checkstyle site -DgenerateReports=false</code></p>
</div>
<div class="paragraph">
<p>Tras la ejecución, en la carpeta <code>target/site/</code> verás el archivo <code>checkstyle.html</code>:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/checkstyle-report-html.png" alt="checkstyle report html">
</div>
<div class="title">Fig. 47. Informe de CheckStyle</div>
</div>
<div class="paragraph">
<p>Sería labor del equipo de desarrollo revisar los errores detectados y tratar de corregirlos, siempre que realmente supongan una mejora para la calidad del código.</p>
</div>
<div class="paragraph">
<p>Para ejecutar y visualizar el informe en Jenkins:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalar el plugin <a href="https://github.com/jenkinsci/warnings-ng-plugin/blob/master/doc/Documentation.md#declarative-pipeline-configuration">Warnings Next Generation</a>.</p>
</li>
<li>
<p>Añadir al pipeline un nuevo <code>stage</code> con la siguiente descripción:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">  <span class="n">stage</span> <span class="o">(</span><span class="s1">'Analysis'</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">steps</span> <span class="o">{</span>
      <span class="c1">// Warnings next generation plugin required</span>
      <span class="n">sh</span> <span class="s2">"mvn checkstyle:checkstyle site -DgenerateReports=false"</span>
      <span class="n">recordIssues</span> <span class="nl">enabledForFailure:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">tool:</span> <span class="n">checkStyle</span><span class="o">()</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras la construcción, el pipeline tiene una nueva fase y además en el menú tenemos acceso al informe de CheckStyle.</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/checkstyle-report-dashboard.png" alt="checkstyle report dashboard">
</div>
<div class="title">Fig. 48. Pipeline con la nueva fase de Análisis</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/checkstyle-report-details.png" alt="checkstyle report details">
</div>
<div class="title">Fig. 49. Detalles del informe de CheckStyle</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Saber más&#8230;&#8203;</div>
<div class="paragraph">
<p>Si estás interesado en profundizar en este tema, te recomiendo integrar <a href="https://www.sonarqube.org/">SonarQube</a> con Jenkins, ya que SonarQube realiza un análisis mucho más detallado de la calidad y seguridad del código, realizando tanto análisis estático de código (CheckStyle y otros), como de análisis de seguridad (vulnerabilidades), y definiendo lo que denomina <a href="https://docs.sonarqube.org/latest/user-guide/quality-gates/"><em>Quality Gates</em></a> que permiten definir condiciones que se deben cumplir basadas en los valores de las métricas del proyecto (por ejemplo, que la cobertura de código sea mayor del 80%). Puedes encontrar mucha documentación online sobre cómo hacerlo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.sonarqube.org/latest/setup/get-started-2-minutes/">Instalar SonarQube</a> como aplicación o como contenedor Docker (recomendado)</p>
</li>
<li>
<p>Instalar el plugin <a href="https://plugins.jenkins.io/sonar/">SonarQube Scanner for Jenkins</a></p>
</li>
<li>
<p><a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/#header-1">Configurar</a> SonarQube Scanner for Jenkins</p>
</li>
<li>
<p><a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-jenkins/#header-6">Añadir al pipeline</a> la fase de análisis de Sonar (<em>Declarative pipeline example:</em>). Más info de Sonar en pipeline: <a href="https://www.jenkins.io/doc/pipeline/steps/sonar/#sonarqube-scanner-for-jenkins">SonarQube Scanner for Jenkins</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Además, Si tu proyecto está en un repositorio público en GitHub, puedes ahorrarte tener que instalar tu propio SonarQube utilizando <a href="https://sonarcloud.io/">SonarCloud</a>, el servicio de SonarQube en la nube (SaaS) gratuito para proyectos públicos, con el que evitas tener que instalar y mantener tu propio SonarQube.</p>
</div>
<div class="paragraph">
<p>Para lanzar el análisis de Sonar con maven:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Genera el login <a href="https://docs.sonarqube.org/latest/user-guide/user-token/">TOKEN</a></p>
</li>
<li>
<p>Ejecuta los goals de maven: <code>clean verify sonar:sonar -Dsonar.login=$SONAR_LOGIN_TOKEN</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Incluso puedes configurar SonarCloud y Jenkins para que  <a href="https://blog.jdriven.com/2019/08/sonarcloud-github-pull-request-analysis-from-jenkins/">analizar los <em>pull request</em></a> de tu repositorio y conocer el resultado del análisis de Sonar antes de hacer el <em>merge</em> del pull request.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_despliegue_en_la_vm">5.4. Despliegue en la VM</h3>
<div class="paragraph">
<p>Para desplegar la aplicación PetClinic en la instancia de despliegue vamos a copiar sobre ella el archivo JAR y a continuación ejecutaremos en ella la orden de java para ponerla en marcha:</p>
</div>
<div class="paragraph">
<p>Copia este nueva fase en tu pipeline, sustituyendo DEPLOY_MACHINE por el nombre DNS de tu instancia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">  <span class="n">stage</span><span class="o">(</span><span class="s1">'Deploy'</span><span class="o">){</span>
    <span class="n">steps</span> <span class="o">{</span>
      <span class="n">sh</span> <span class="s1">'''
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "mkdir -p ~/spring-petclinic" <i class="conum" data-value="1"></i><b>(1)</b>
        scp -i ~/.ssh/id_rsa_deploy $WORKSPACE/target/*.jar ubuntu@DEPLOY_MACHINE:~/spring-petclinic <i class="conum" data-value="2"></i><b>(2)</b>
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "if pgrep java; then pkill java; fi" <i class="conum" data-value="3"></i><b>(3)</b>
        ssh -i ~/.ssh/id_rsa_deploy ubuntu@DEPLOY_MACHINE "nohup java -jar ~/spring-petclinic/*.jar &gt; ~/spring-petclinic/yourservice.log 2&gt;&amp;1 &amp;" <i class="conum" data-value="4"></i><b>(4)</b>
      '''</span>
    <span class="o">}</span>
  <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crea la carpeta <code>spring-petclinic</code> dentro de la carpeta HOME del usuario <code>ubuntu</code> en la máquina de despliegue</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Copia con <code>scp</code> el archivo <code>.jar</code>, que se ha generado tras la construcción con maven, en la máquina de despligue</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Detiene el proceso <code>java</code> si existe de un despliegue anterior.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ejecuta la aplicación java empaquetada en el <code>.jar</code>, en background y con <code>nohup</code>, que hace que el proceso siga funcionando incluso si el usuario que lo inició cierra la sesión. De esta manera finaliza el comando ssh y el proceso sigue funcionando, es decir, la aplicación PetClinic estará desplegada y funcionando.</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Referencias:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://medium.com/@weblab_tech/how-to-publish-artifacts-in-jenkins-f021b17fde71">How to build on Jenkins and publish artifacts via ssh with Pipelines</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_despliegue_en_un_contenedor_docker">5.5. Despliegue en un contenedor Docker</h3>
<div class="paragraph">
<p>Para realizar el despliegue de PetClinic como contenedor, primero tenemos que <a href="https://www.callicoder.com/spring-boot-docker-example/">dockerizar</a> la aplicación, luego publicar la imagen de contenedor en un registro como DockerHub o Google Container Registry, y por último ejecutar el contenedor en la instancia de despliegue.</p>
</div>
<div class="paragraph">
<p>A continuación se describe cómo crear un contenedor Docker de la aplicación PetClinic. Los pasos se realizan en local, y al final configuraremos el pipeline de Jenkins para que se realicen automáticamente.</p>
</div>
<div class="sect3">
<h4 id="_creación_del_dockerfile">5.5.1. Creación del <code>Dockerfile</code></h4>
<div class="paragraph">
<p>Para <a href="https://spring.io/guides/gs/spring-boot-docker/">crear el contendedor de Docker</a> que empaquete la aplicación PetClinic, vamos a definir el siguiente archivo <code>Dockerfile</code> que debe estar en la carpeta raíz del proyecto:</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="docker"><span class="c"># Start with a base image containing Java runtime</span>
<span class="k">FROM</span><span class="s"> openjdk:8-jdk-alpine</span>
<span class="c"># Make port 8080 available to the world outside this container</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>
<span class="c"># The application's jar file</span>
<span class="k">ARG</span><span class="s"> JAR_FILE=target/*.jar</span>
<span class="c"># Copy the application's jar to the container</span>
<span class="k">COPY</span><span class="s"> ${JAR_FILE} app.jar</span>
<span class="c"># Run the jar file</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["java","-jar","/app.jar"]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El Dockerfile es muy sencillo, contiene los pasos básicos para ejecutar una aplicación String Boot en un contenedor: partiendo de una imagen de <code>openjdk</code>, copia el archivo <code>target/*.jar</code> en el contenedor con el nombre <code>app.jar</code> y lo ejecuta mediante el comando <code>ENTRYPOINT</code> para que no haya ninguna shell sobre el proceso <code>java</code>.</p>
</div>
<div class="paragraph">
<p>Puedes construir la imagen del contenedor:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Construye el proyecto PetClinic con maven en tu equipo local:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw clean package</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/mvn-package-petclinic.png" alt="mvn package petclinic">
</div>
<div class="title">Fig. 50. Resultado de la construcción local con Maven</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Construye el contenedor con <code>docker build</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker build <span class="nt">-t</span> petclinic-docker .</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/docker-build-petclinic.png" alt="docker build petclinic">
</div>
<div class="title">Fig. 51. Docker build</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para trabajar con contenedores Docker en tu equipo local, debes tener Docker instalado. Recuerda iniciar Docker Desktop en Windows, o iniciar el servicio Docker en Linux o Mac. Comprueba que está funcionado ejecutando el comando <code>docker ps</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Prueba la ejecución del contenedor en local:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker run <span class="nt">-it</span> <span class="nt">-p</span> 8080:8080 <span class="nt">-t</span> petclinic-docker</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprueba que se ha iniciado la aplicación en <a href="http://localhost:8080" class="bare">http://localhost:8080</a>.</p>
</div>
<div class="paragraph">
<p>Para el contenedor con CTRL+C.</p>
</div>
<div class="paragraph">
<p>Una vez creada la imagen con <code>docker build</code> y probada su ejecución con <code>docker run</code>, el siguiente paso será publicar la imagen en un registro de contenedores, mediante <code>docker push</code>. Podemos usar <a href="https://hub.docker.com/">DockerHub</a> pero en este caso vamos a usar Google Cloud <a href="https://cloud.google.com/container-registry?hl=es">Container Registry</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_autenticación_en_container_registry">5.5.2. Autenticación en Container Registry</h4>
<div class="paragraph">
<p>Para poder hacer <code>push</code> debemos tener permisos de escritura, y por tanto debemos autenticarnos en el servicio Container Registry.</p>
</div>
<div class="paragraph">
<p><a href="https://cloud.google.com/container-registry/docs/advanced-authentication">Authentication</a> <em>allows you to connect to Container Registry with your credentials. To push or pull images, you must configure the permissions that are required to access the registry.</em></p>
</div>
<div class="paragraph">
<p><em>Using <a href="https://cloud.google.com/container-registry/docs/advanced-authentication#json-key">JSON key file</a> as authentication method:</em></p>
</div>
<div class="paragraph">
<p><em>To create a new service account and a service account key for use with Container Registry repositories only:</em></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>Create the service account for interacting with repositories:</em></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In Google Cloud Console, open the <a href="https://console.cloud.google.com/apis/credentials/serviceaccountkey?" class="bare">https://console.cloud.google.com/apis/credentials/serviceaccountkey?</a><em>ga=2.71233296.1082389881.1588672109-358507209.1586347394[Create service account key page].</em></p>
</li>
<li>
<p><em>From the Service account list, select New service account</em></p>
</li>
<li>
<p><em>In the Service account name field, enter a name</em></p>
</li>
<li>
<p><em>From the Role list, select the appropriate Container Registry role for the service account: Cloud Storage / Storage Administrator</em></p>
</li>
<li>
<p><em>Click Create. A JSON file that contains your key downloads to your computer.</em></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/cloud-containers-registry-key-create.png" alt="cloud containers registry key create">
</div>
<div class="title">Fig. 52. Creación Service Account Key for pull/push on Container Registry</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Guarda el archivo <code>.json</code> en la carpeta <code>secret</code> de tu proyecto PetClinic.</p>
</li>
</ol>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>No olvides añadir la carpeta <code>secret/</code> al archivo <code>.gitignore</code> para evitar publicar en GitHub tu archivo de credenciales.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p><em>Use the service account key as your password to authenticate with Docker.</em> Sustituye <code>keyfile.json</code> por el nombre de tu archivo de credenciales:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>En Linux:</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">cat </span>keyfile.json | docker login <span class="nt">-u</span> _json_key <span class="nt">--password-stdin</span> https://gcr.io</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a" start="2">
<li>
<p>En Windows:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker login <span class="nt">-u</span> _json_key <span class="nt">--password-stdin</span> https://gcr.io &lt; keyfile.json</code></pre>
</div>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/cloud-containers-registry-login.png" alt="cloud containers registry login">
</div>
<div class="title">Fig. 53. Autenticación de Docker contra Container Registry</div>
</div>
</div>
<div class="sect3">
<h4 id="_publicación_y_despliegue">5.5.3. Publicación y despliegue</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Construir el contenedor con el nombre completo incluyendo la referencia a Container registry (gcr.io). Primero definimos una variable de entorno con el nombre de nuestro proyecto GCP, y luego construimos de nuevo la imagen con el nombre completo del registro de contenedores:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">GOOGLE_CLOUD_PROJECT</span><span class="o">=</span>cnsa-2020-user123

docker build <span class="nt">-t</span> gcr.io/<span class="nv">$GOOGLE_CLOUD_PROJECT</span>/petclinic:1.0 .</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>A continuación vamos a publicar con <code>docker push</code>: habilita la API de Container Registry en tu proyecto GCP</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/container-registry-habilitar-api.png" alt="container registry habilitar api">
</div>
<div class="title">Fig. 54. Habilitar la API Container Registry</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Publica la imagen con <code><code>docker push [HOSTNAME]/[PROJECT-ID]/[IMAGE]:[TAG]</code></code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker push gcr.io/<span class="nv">$GOOGLE_CLOUD_PROJECT</span>/petclinic:1.0</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Comprueba que se ha publicado correctamente.</p>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/container-registry-pushed-petclinic.png" alt="container registry pushed petclinic">
</div>
<div class="title">Fig. 55. Lista de imágenes en Container Registry</div>
</div>
<div class="paragraph">
<p>La imagen ya está disponible en nuestro repositorio privado de nuestro proyecto GCP. Utilizando nuestras credenciales podremos hacer <code>docker pull</code> de dicha imagen para descargarla en cualquier sistema con el motor de docker, y ejecutarlo con <code>docker run</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">GOOGLE_CLOUD_PROJECT</span><span class="o">=</span>cnsa-2020-user123

docker run <span class="nt">-p</span> 8080:8080 <span class="nt">-t</span> <span class="nt">--name</span> petclinic  gcr.io/<span class="nv">$GOOGLE_CLOUD_PROJECT</span>/petclinic:1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si conectas a la instancia de despliegue que creamos al principio de esta actividad, y ejecutas el comando <code>docker run</code> anterior, dará un error de autenticación:</p>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/docker-run-petclinic-webapp-error-authentication.png" alt="docker run petclinic webapp error authentication">
</div>
<div class="title">Fig. 56. Error de autenticación en Container Registry</div>
</div>
<div class="paragraph">
<p>Para arreglarlo, habrá que copiar en la máquina de despliegue el archivo de credenciales <code>.json</code> con premisos sobre Container Registry, una vez disponible este archivo en la instancia de despliegue ejecutar el comando <code>docker login</code> y tras ello ya si podremos hacer <code>docker pull</code> y <code>docker run</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c"># Compiamos el archivo de credenciales</span>
scp ./secret/file.json ubuntu@DNS_MAQUINA_DEPLOY:~/file.json
<span class="c"># Conectamos a la máquina de despliegue</span>
ssh ubuntu@DNS_MAQUINA_DEPLOY
<span class="c"># Autenticamos docker contra Container Registry</span>
<span class="nb">cat </span>keyfile.json | docker login <span class="nt">-u</span> _json_key <span class="nt">--password-stdin</span> https://gcr.io
<span class="c"># ejecutamos el contenedor desde gcr.io</span>
docker run <span class="nt">-p</span> 8080:8080 <span class="nt">-t</span> <span class="nt">--name</span> petclinic gcr.io/<span class="nv">$GOOGLE_CLOUD_PROJECT</span>/petclinic:1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Es posible que la ejecución del contenedor de un error, porque el puerto 8080 ya esté en uso:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">Error starting userland proxy: listen tcp 0.0.0.0:8080: <span class="nb">bind</span>: address already <span class="k">in </span>use.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para solucionarlo, bien detén el proceso java que está corriendo con la aplicación PetClinic tal y como la desplegamos en la sección anterior (<code><code>if pgrep java; then pkill java; fi</code></code>), o bien utiliza otro puerto, por ejemplo, el 80, que debe estar disponible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker run <span class="nt">-p</span> 80:8080 <span class="nt">-t</span> <span class="nt">--name</span> petclinic gcr.io/<span class="nv">$GOOGLE_CLOUD_PROJECT</span>/petclinic:1.0</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_construcción_de_la_imagen_y_despliegue_del_contenedor_con_jenkins">5.5.4. Construcción de la imagen y despliegue del contenedor con Jenkins</h4>
<div class="paragraph">
<p>A continuación vamos a automatizar con Jenkins los tres procesos descritos anteriormente de forma "manual": la construcción de la imagen del contenedor, la publicación de la imagen en el registro, y el despliegue del contenedor.</p>
</div>
<div class="paragraph">
<p>Son necesarios los siguientes plugins para trabajar con docker y pipelines y con Container Registry: Docker Pipeline (que ya está instalado), <a href="https://plugins.jenkins.io/google-container-registry-auth">Google Container Registry Auth</a></p>
</div>
<div class="paragraph">
<p>Definimos un nuevo proyecto en Jenkins de tipo pipeline, con el nombre <code><code>PetClinic-Docker-abc123</code></code> sustituyendo abc123 por nuestro nombre de usuario. Son necesarios 3 fases (stages) en el pipeline: build image, push image, y deploy container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">agent</span> <span class="n">any</span>
  <span class="n">environment</span> <span class="o">{</span>
    <span class="n">CONTAINER_REGISTRY</span> <span class="o">=</span> <span class="s1">'gcr.io'</span>
    <span class="n">GOOGLE_CLOUD_PROJECT</span> <span class="o">=</span> <span class="s1">'cnsa-2020'</span>
    <span class="n">CREDENTIALS_ID</span> <span class="o">=</span> <span class="s1">'cnsa-2020-gcr'</span>
  <span class="o">}</span>
  <span class="n">tools</span> <span class="o">{</span>
    <span class="n">maven</span> <span class="s2">"Default Maven"</span>
  <span class="o">}</span>
  <span class="n">stages</span> <span class="o">{</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"Checkout code"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="c1">// checkout scm</span>
        <span class="n">git</span> <span class="s1">'https://github.com/ualcnsa/spring-petclinic.git'</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">'Compile, Test, Package'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">"mvn clean package"</span>
      <span class="o">}</span>
      <span class="n">post</span> <span class="o">{</span>
        <span class="n">success</span> <span class="o">{</span>
          <span class="n">junit</span> <span class="s1">'**/target/surefire-reports/TEST-*.xml'</span>
          <span class="n">archiveArtifacts</span> <span class="s1">'target/*.jar'</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span><span class="o">(</span><span class="s2">"Build image"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">script</span> <span class="o">{</span>
          <span class="n">dockerImage</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">build</span><span class="o">(</span>
            <span class="s2">"${env.CONTAINER_REGISTRY}/${env.GOOGLE_CLOUD_PROJECT}/petclinic:${env.BUILD_ID}"</span><span class="o">,</span>
            <span class="s2">"-f Dockerfile ."</span>
          <span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para probar que el contenedor se ha creado bien, añade esta fase que hace un despliegue "local" en la propia máquina de Jenkins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">    <span class="n">stage</span><span class="o">(</span><span class="s2">"Run image locally"</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">"docker stop petclinic || true &amp;&amp; docker rm  petclinic || true"</span>
        <span class="n">sh</span> <span class="s2">"mkdir -p logs"</span>
        <span class="n">sh</span> <span class="s2">"nohup docker run -p 8080:8080 -t --name petclinic ${env.CONTAINER_REGISTRY}/${env.GOOGLE_CLOUD_PROJECT}/petclinic:${env.BUILD_ID} &gt; logs/yourservice-docker-${env.BUILD_ID}.log 2&gt;&amp;1 &amp;"</span>
      <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>La aplicación debe estar accesible en el puerto 8080 en tu máquina de Jenkins. Para asegurarnos que la aplicación se está ejecutando bien, lo adecuado sería realizar unos tests end-to-end, con Selenium.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">    <span class="n">stage</span><span class="o">(</span><span class="s1">'End-to-end Test image'</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">/*</span> <span class="n">Ideally</span><span class="o">,</span> <span class="n">we</span> <span class="n">would</span> <span class="n">run</span> <span class="n">some</span> <span class="n">end</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">end</span> <span class="n">tests</span> <span class="n">against</span> <span class="n">our</span> <span class="n">running</span> <span class="n">container</span><span class="o">.</span>
        <span class="n">steps</span><span class="o">{</span>
            <span class="n">sh</span> <span class="s1">'echo "End-to-end Tests passed"'</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El siguiente paso es publicar la imagen en el registro.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primero, es necesario crear unas credenciales en Jenkins para poder hacer <code>push</code> en Container Registry:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>Go to jenkins home, click on “credentials” and “(global)”</em></p>
</li>
<li>
<p><em>Click on “Add Credentials” in left menu.</em></p>
</li>
<li>
<p>_Select <strong>Google Service Account from private key</strong> for the “Kind” field, and enter your project name ( myregistry in this example). Then upload the JSON private key.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="imageblock text-center thumb">
<div class="content">
<img src="images/jenkins-credentials-container-registry.png" alt="jenkins credentials container registry">
</div>
<div class="title">Fig. 57. Credenciales en Jenkins para Container Registry</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Una vez guardadas las credenciales, vamos a definir la fase para publicar la imagen del contenedor:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">    <span class="n">stage</span><span class="o">(</span><span class="s2">"Push image"</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">steps</span> <span class="o">{</span>
            <span class="n">script</span> <span class="o">{</span>
                <span class="n">docker</span><span class="o">.</span><span class="na">withRegistry</span><span class="o">(</span><span class="s1">'https://'</span><span class="o">+</span> <span class="n">CONTAINER_REGISTRY</span><span class="o">,</span> <span class="s1">'gcr:'</span><span class="o">+</span> <span class="n">GOOGLE_CLOUD_PROJECT</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">dockerImage</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s2">"latest"</span><span class="o">)</span>
                        <span class="n">dockerImage</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s2">"${env.BUILD_ID}"</span><span class="o">)</span>

            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprobar que se ha publicado correctamente en el registro.</p>
</div>
<div class="paragraph">
<p>Por último, quedaría el paso de desplegar al entorno de producción. Una vez empaquetada como un contenedor, una aplicación se puede desplegar de varias formas: en máquina virtual con GCE, en plataforma como servicio con Google App Engine, en Kubernetes con GKE, y en Cloud Run, un servicio de Google Cloud específico para el despliegue de contenedores. Para nosotros es nuestra máquina virtual de despliegue es nuestro entorno de producción en el que vamos a desplegar el contenedor.</p>
</div>
<div class="paragraph">
<p>Los pasos para el despliegue de la nueva imagen del contenedor consistirán en ejecutar los siguientes comandos sobre la máquina de despliegue:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>docker stop</code> del contenedor por si estuviera ejecutándose</p>
</li>
<li>
<p><code>docker rm</code> para eliminar la imagen existente, de una versión anterior</p>
</li>
<li>
<p><code>docker run</code> que automáticamente hará primero un <code>docker pull</code> de la imagen actualizada del registro. Lo lanzaremos en el puerto 80 ya que el 8080 está ocupado por el despliegue sin contenedor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Estas acciones debemos añadirlas a un <code>stage</code> del pipeline de Jenkins que se encargará de desplegar el nuevo contenedor automáticamente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">    <span class="n">stage</span><span class="o">(</span><span class="s1">'Deploy to Production'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span><span class="o">{</span>
        <span class="n">sh</span> <span class="s1">'''
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@webapps.mastertaiiual.tech "mkdir -p  ~/logs"
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@webapps.mastertaiiual.tech " if docker ps -q --filter name=petclinic | grep . ; then docker stop petclinic &amp;&amp; docker rm -fv petclinic; fi"
          ssh -i ~/.ssh/id_rsa_deploy ubuntu@webapps.mastertaiiual.tech "nohup docker run -p 80:8080 -t --name petclinic ${CONTAINER_REGISTRY}/${GOOGLE_CLOUD_PROJECT}/petclinic:latest  &gt; logs/yourservice-docker.log 2&gt;&amp;1 &amp;"
        '''</span>
      <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code># Remove all stopped containers
docker rm $(docker ps -a -q)
# Remove all images
docker rmi $(docker images -q)</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por último, es una buena práctica eliminar las imágenes que se van generando en cada build. Primero paramos y eliminamos el contenedor local, luego eliminamos la imagen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy">    <span class="n">stage</span><span class="o">(</span><span class="s1">'Remove Unused docker image'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span><span class="o">{</span>
        <span class="c1">// input message:"Proceed with removing image locally?"</span>
        <span class="n">sh</span> <span class="s1">'if docker ps -q --filter name=petclinic | grep . ; then docker stop petclinic &amp;&amp; docker rm -fv petclinic; fi'</span>
        <span class="n">sh</span> <span class="s1">'docker rmi ${CONTAINER_REGISTRY}/${GOOGLE_CLOUD_PROJECT}/petclinic:$BUILD_NUMBER'</span>
      <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Referencias</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://stackoverflow.com/questions/54573068/pushing-docker-image-through-jenkins" class="bare">https://stackoverflow.com/questions/54573068/pushing-docker-image-through-jenkins</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ejemplo_2_hola_mundo_en_nodejs">6. Ejemplo 2. Hola mundo en NodeJs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nos vamos a basar en el proyecto HelloWorld en NodeJs, disponible en https&#8230;&#8203;.</p>
</div>
<div class="sect2">
<h3 id="_creación_de_proyecto_jenkins_con_pipelines_2">6.1. Creación de proyecto Jenkins con pipelines</h3>
<div class="paragraph">
<p>Configuramos el Pipeline.</p>
</div>
</div>
<div class="sect2">
<h3 id="_despliegue_en_la_vm_2">6.2. Despliegue en la VM</h3>

</div>
<div class="sect2">
<h3 id="_deploy_en_un_docker_container">6.3. Deploy en un Docker container</h3>

</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-05-10 12:02:53 +0200
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>
